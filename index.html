<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wolf RPG Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #050a05; overflow: hidden; font-family: sans-serif; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hud { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.85); border-left: 5px solid #00ffcc; padding: 15px; border-radius: 0 10px 10px 0; pointer-events: auto; }
        .xp-bar { width: 150px; height: 8px; background: #333; margin-top: 10px; border-radius: 4px; overflow: hidden; }
        #xp-fill { height: 100%; background: #00ffcc; width: 0%; transition: width 0.3s; }
        #altar-btn { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #ffd700; border: none; padding: 15px 40px; border-radius: 10px; font-weight: bold; pointer-events: auto; }
    </style>
</head>
<body>

<div id="ui">
    <div class="hud">
        <div style="color: white; font-weight: bold;" id="lvl-txt">ALFA LVL 1</div>
        <div style="color: #ffd700; font-size: 11px;" id="orb-txt">MAPA: 1 | ORBES: 0</div>
        <div class="xp-bar"><div id="xp-fill"></div></div>
    </div>
    <button id="altar-btn" onclick="alert('ALTAR: 10 Orbes (Épico) / 60 Orbes (Legendario)\n\nCaza animales en el Mapa 4 para encontrarlos.')">ALTAR SAGRADO</button>
</div>

<script>
// El cambio de clave obliga al navegador a resetear la memoria vieja
const REFRESH_KEY = "WOLF_V20_FINAL_BODY";
let data = JSON.parse(localStorage.getItem(REFRESH_KEY)) || { level: 1, exp: 0, orbes: 0, mapa: 1 };

const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'arcade' },
    scene: { preload: preload, create: create, update: update }
};

const game = new Phaser.Game(config);
let player, preys;

function preload() {
    // Forzamos la carga de imágenes nuevas con un parámetro de tiempo (?t=...)
    let t = Date.now();
    this.load.image('grass', 'https://labs.phaser.io/assets/textures/tileset-grass.png?v=' + t);
    this.load.image('wolf_full', 'https://img.icons8.com/color/144/wolf.png?v=' + t);
    this.load.image('deer', 'https://img.icons8.com/color/96/deer.png?v=' + t);
}

function create() {
    this.add.tileSprite(0, 0, 8000, 8000, 'grass').setOrigin(0).setAlpha(0.5);
    this.cameras.main.setBounds(0, 0, 4000, 4000);
    this.physics.world.setBounds(0, 0, 4000, 4000);

    // Lobo de cuerpo completo
    player = this.physics.add.sprite(2000, 2000, 'wolf_full');
    player.setOrigin(0.5, 0.5);
    player.setScale(0.8);
    this.cameras.main.startFollow(player, true, 0.1, 0.1);

    preys = this.physics.add.group();
    for(let i=0; i<20; i++) spawnPrey(this);

    // Sistema de caza y tus reglas de orbes
    this.physics.add.overlap(player, preys, (p, animal) => {
        animal.destroy();
        this.cameras.main.shake(100, 0.01);
        data.exp += 35;

        if(data.exp >= 100) {
            data.level++;
            data.exp = 0;
            data.mapa = Math.floor(data.level/5) + 1;
        }

        // REGLA: Orbes aparecen en Mapa 4 o Nivel 20
        if(data.level >= 20 || data.mapa >= 4) {
            if(Math.random() < 0.25) data.orbes++;
        }

        updateHUD();
        spawnPrey(this);
    }, null, this);

    updateHUD();
}

function update() {
    if (this.input.activePointer.isDown) {
        this.physics.moveToObject(player, this.input.activePointer, 300);
        let angle = Phaser.Math.Angle.Between(player.x, player.y, this.input.activePointer.worldX, this.input.activePointer.worldY);
        player.rotation = Phaser.Math.Angle.RotateTo(player.rotation, angle + 1.5, 0.1);
    } else {
        player.body.setVelocity(0);
    }
}

function spawnPrey(scene) {
    let x = Phaser.Math.Between(200, 3800);
    let y = Phaser.Math.Between(200, 3800);
    scene.physics.add.sprite(x, y, 'deer').setScale(0.6).setParentContainer(preys);
}

function updateHUD() {
    localStorage.setItem(REFRESH_KEY, JSON.stringify(data));
    document.getElementById('lvl-txt').innerText = `ALFA LVL ${data.level}`;
    document.getElementById('orb-txt').innerText = `MAPA: ${data.mapa} | ORBES: ${data.orbes}`;
    document.getElementById('xp-fill').style.width = data.exp + '%';
}
</script>
</body>
</html>
