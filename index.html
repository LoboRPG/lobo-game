<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wolf Simulator 3D - Alfa Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #050a05; font-family: sans-serif; touch-action: none; }
        #ui { position: fixed; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border-left: 5px solid #daa520; z-index: 10; pointer-events: none; }
        #orb-ui { position: fixed; top: 20px; right: 20px; color: #ffd700; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; display: none; z-index: 10; font-weight: bold; }
        #controls { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: space-around; z-index: 20; }
        .joy-base { width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #fff; position: relative; }
        .joy-stick { width: 40px; height: 40px; background: #fff; border-radius: 50%; position: absolute; top: 30px; left: 30px; }
        .atk-btn { width: 85px; height: 85px; background: #8b0000; border-radius: 50%; border: 3px solid #fff; color: white; display: flex; align-items: center; justify-content: center; font-size: 35px; }
    </style>
</head>
<body>
    <div id="ui">
        <b>üê∫ LOBO ALFA</b><br>
        Nivel: <span id="lv">1</span> | Mapa: <span id="map-txt">1</span>
    </div>
    <div id="orb-ui">‚ú® Orbes: <span id="orb-count">0</span>/60</div>

    <div id="controls">
        <div class="joy-base" id="joy-base"><div class="joy-stick" id="joy-stick"></div></div>
        <div class="atk-btn" id="atk-btn">‚öîÔ∏è</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        let scene, camera, renderer, wolf;
        let joystick = { x: 0, y: 0 };
        let preys = [];
        let stats = { lv: 1, xp: 0, orbes: 0, mapa: 1 };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a2e15); // Fondo verde oscuro para evitar el "blanco"
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 15);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Luces suaves
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(5, 15, 5);
            scene.add(sun);

            // Suelo
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({ color: 0x0d1f0d }));
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            // CARGA DE LOBO (Con sistema de emergencia)
            const loader = new THREE.GLTFLoader();
            loader.load('https://raw.githubusercontent.com/mkkellogg/ThreeJs-Wolf-Simulation/master/models/wolf.glb', 
            (gltf) => {
                wolf = gltf.scene;
                wolf.scale.set(1.5, 1.5, 1.5);
                scene.add(wolf);
            }, undefined, () => {
                // SI EL ENLACE FALLA, CREA UN LOBO REALISTA CON C√ìDIGO
                crearLoboPro();
            });

            spawnPrey();
            animate();
        }

        function crearLoboPro() {
            wolf = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({color: 0x444444});
            // Cuerpo org√°nico (Capsula)
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.5, 4, 8), mat);
            body.rotation.x = Math.PI/2;
            // Cabeza
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.5, 16, 16), mat);
            head.position.set(0, 0.6, 1.2);
            // Hocico
            const snout = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.6), mat);
            snout.position.set(0, 0.5, 1.7);
            
            wolf.add(body, head, snout);
            scene.add(wolf);
        }

        function spawnPrey() {
            const geo = new THREE.SphereGeometry(0.6, 8, 8);
            for(let i=0; i<10; i++) {
                const p = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0xaa5500 }));
                p.position.set(Math.random()*60-30, 0.6, Math.random()*60-30);
                scene.add(p);
                preys.push(p);
            }
        }

        function checkOrbs() {
            // Regla: Nivel 20 o Mapa 4 [cite: 2026-01-10]
            if(stats.lv >= 20 || stats.mapa >= 4) {
                document.getElementById('orb-ui').style.display = 'block';
                if(Math.random() < 0.35) {
                    stats.orbes++;
                    document.getElementById('orb-count').innerText = stats.orbes;
                    if(stats.orbes === 10) tg.showAlert("‚ú® ¬°Deseo √âpico!"); [cite: 2026-01-10]
                    if(stats.orbes === 60) tg.showAlert("üî• ¬°Deseo Legendario!"); [cite: 2026-01-10]
                }
            }
        }

        // Joystick
        const base = document.getElementById('joy-base');
        const stick = document.getElementById('joy-stick');
        base.addEventListener('touchmove', e => {
            const r = base.getBoundingClientRect();
            const x = e.touches[0].clientX - (r.left + 50);
            const y = e.touches[0].clientY - (r.top + 50);
            const d = Math.min(Math.sqrt(x*x+y*y), 40);
            const a = Math.atan2(y, x);
            joystick.x = Math.cos(a) * (d/40);
            joystick.y = Math.sin(a) * (d/40);
            stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
        });
        base.addEventListener('touchend', () => {
            joystick.x = 0; joystick.y = 0;
            stick.style.transform = 'translate(0,0)';
        });

        document.getElementById('atk-btn').addEventListener('touchstart', () => {
            tg.HapticFeedback.impactOccurred('medium');
            preys.forEach((p, i) => {
                if(wolf.position.distanceTo(p.position) < 4) {
                    scene.remove(p);
                    preys.splice(i, 1);
                    stats.xp += 34;
                    checkOrbs();
                    if(stats.xp >= 100) {
                        stats.lv++; stats.xp = 0;
                        document.getElementById('lv').innerText = stats.lv;
                    }
                }
            });
            if(preys.length < 3) spawnPrey();
        });

        function animate() {
            requestAnimationFrame(animate);
            if(wolf) {
                wolf.position.x += joystick.x * 0.25;
                wolf.position.z += joystick.y * 0.25;
                if(Math.abs(joystick.x) > 0.1 || Math.abs(joystick.y) > 0.1) {
                    wolf.rotation.y = -Math.atan2(joystick.y, joystick.x) + Math.PI/2;
                }
                camera.position.lerp(new THREE.Vector3(wolf.position.x, 10, wolf.position.z + 15), 0.1);
                camera.lookAt(wolf.position);
            }
            renderer.render(scene, camera);
        }
        init();
    </script>
</body>
</html>
