<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wolf Simulator MMO - Orbes de Poder üê∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: linear-gradient(180deg, #228B22 0%, #006400 70%, #2F4F2F 100%); font-family: 'Arial Black', Arial, sans-serif; overflow: hidden; color: #fff; touch-action: none; }
        canvas { display: block; touch-action: none; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 20; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 15px; font-size: 14px; min-width: 200px; }
        #stats { display: flex; justify-content: space-between; margin-bottom: 10px; }
        #xp-bar { height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        #xp-fill { height: 100%; background: linear-gradient(90deg, #ffaa00, #ff4400); transition: width 0.3s; }
        #buttons { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 20; }
        button { background: linear-gradient(145deg, #0088cc, #005a99); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: all 0.2s; white-space: nowrap; }
        
        /* Contador de Orbes Personalizado */
        #orb-ui { margin-top: 5px; color: #ffd700; font-weight: bold; display: none; }
        
        #minimap { position: absolute; top: 10px; right: 10px; width: 120px; height: 120px; background: rgba(0,0,0,0.8); border: 2px solid #fff; border-radius: 10px; z-index: 20; }
        #joystick { position: absolute; bottom: 100px; left: 20px; width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 4px solid rgba(255,255,255,0.5); display: none; z-index: 15; touch-action: none; }
        #joystick-knob { position: absolute; width: 40px; height: 40px; background: rgba(255,255,255,0.8); border-radius: 50%; left: 30px; top: 30px; }
        #mode-tag { position: absolute; top: 10px; right: 140px; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="stats">
            <div>
                <div>üê∫ <span id="playerName">Lobo</span></div>
                <div>HP: <span id="hp">100</span>/100</div>
            </div>
            <div>
                Nivel: <span id="level">1</span>
                <div id="xp-bar"><div id="xp-fill" style="width:0%"></div></div>
                <div>XP: <span id="xp">0</span>/100</div>
            </div>
        </div>
        <div>Hambre: <span id="hunger">100</span> | Mapa: <span id="mapDisplay">1</span></div>
        <div id="orb-ui">‚ú® Orbes: <span id="orbCount">0</span>/60</div>
    </div>

    <div id="minimap"></div>
    <div id="mode-tag">Modo: Caza ü¶å</div>
    <div id="joystick"><div id="joystick-knob"></div></div>

    <div id="buttons">
        <button id="arenaBtn">Arena PvP ‚öîÔ∏è</button>
        <button id="huntBtn">Caza üèπ</button>
        <button id="nextMapBtn" style="background: linear-gradient(145deg, #e67e22, #d35400);">Siguiente Mapa üó∫Ô∏è</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        'use strict';
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let WIDTH, HEIGHT;

        function resize() {
            WIDTH = window.innerWidth;
            HEIGHT = window.innerHeight;
            canvas.width = WIDTH;
            canvas.height = HEIGHT;
        }
        window.addEventListener('resize', resize);
        resize();

        const WORLD_SIZE = 4000;
        let player = { x: 2000, y: 2000, vx: 0, vy: 0, speed: 4, angle: 0, hp: 100, maxHp: 100, xp: 0, level: 1, hunger: 100, attackCooldown: 0, orbes: 0, mapa: 1 };
        let camera = { x: 0, y: 0 };
        let prey = [];
        let joystickActive = false;
        let joystickAngle = 0;

        const PREY_TYPES = [
            { emoji: 'üê∞', size: 25, xp: 15, hp: 30 },
            { emoji: 'ü¶ä', size: 30, xp: 30, hp: 50 },
            { emoji: 'ü¶å', size: 40, xp: 60, hp: 80 }
        ];

        function spawnPrey() {
            prey = [];
            for (let i = 0; i < 15; i++) {
                prey.push({
                    x: Math.random() * WORLD_SIZE,
                    y: Math.random() * WORLD_SIZE,
                    type: Math.floor(Math.random() * PREY_TYPES.length),
                    hp: 50, vx: 0, vy: 0
                });
            }
        }

        // --- CONTROLES T√ÅCTILES ---
        canvas.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            const d = Math.hypot(touch.clientX - WIDTH/2, touch.clientY - HEIGHT/2);
            if(d < 100 && player.attackCooldown <= 0) {
                atacar();
            } else {
                joystickActive = true;
                document.getElementById('joystick').style.display = 'block';
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!joystickActive) return;
            const touch = e.touches[0];
            const dx = touch.clientX - 70; // Posici√≥n fija del joystick
            const dy = (HEIGHT - touch.clientY) - 150;
            joystickAngle = Math.atan2(dy, dx);
            const knob = document.getElementById('joystick-knob');
            knob.style.left = (30 + Math.cos(joystickAngle) * 20) + 'px';
            knob.style.top = (30 - Math.sin(joystickAngle) * 20) + 'px';
        });

        canvas.addEventListener('touchend', () => {
            joystickActive = false;
            document.getElementById('joystick').style.display = 'none';
        });

        function atacar() {
            player.attackCooldown = 20;
            tg.HapticFeedback.impactOccurred('medium');
            prey.forEach((p, i) => {
                const d = Math.hypot(p.x - player.x, p.y - player.y);
                if (d < 80) {
                    p.hp -= 30;
                    if (p.hp <= 0) {
                        player.xp += 40;
                        player.hunger = Math.min(100, player.hunger + 10);
                        prey.splice(i, 1);
                        
                        // REGLA DE ORBES
                        if (player.level >= 20 || player.mapa >= 4) {
                            document.getElementById('orb-ui').style.display = 'block';
                            if (Math.random() < 0.4) { // Probabilidad media
                                player.orbes++;
                                checkOrbes();
                            }
                        }
                        checkLevel();
                    }
                }
            });
        }

        function checkOrbes() {
            document.getElementById('orbCount').textContent = player.orbes;
            if (player.orbes === 10) tg.showAlert("‚ú® ¬°10 Orbes! Puedes pedir un deseo √âpico.");
            if (player.orbes === 60) tg.showAlert("üî• ¬°60 Orbes! Tienes el poder del deseo Legendario.");
        }

        function checkLevel() {
            if (player.xp >= 100) {
                player.level++;
                player.xp = 0;
                tg.showAlert(`¬°Nivel ${player.level}!`);
                if (player.level === 20) tg.showAlert("¬°Has desbloqueado la caza de Orbes!");
            }
        }

        function siguienteMapa() {
            player.mapa++;
            spawnPrey();
            tg.showAlert(`Entrando al Mapa ${player.mapa}`);
            if (player.mapa === 4) tg.showAlert("¬°Mapa 4! Los orbes m√°gicos ahora aparecen aqu√≠.");
            document.getElementById('mapDisplay').textContent = player.mapa;
        }

        function update() {
            if (player.attackCooldown > 0) player.attackCooldown--;
            if (joystickActive) {
                player.x += Math.cos(joystickAngle) * player.speed;
                player.y -= Math.sin(joystickAngle) * player.speed;
            }
            player.x = Math.max(0, Math.min(WORLD_SIZE, player.x));
            player.y = Math.max(0, Math.min(WORLD_SIZE, player.y));
            
            camera.x = player.x - WIDTH / 2;
            camera.y = player.y - HEIGHT / 2;

            if (prey.length < 5) spawnPrey();

            // UI
            document.getElementById('hp').textContent = Math.floor(player.hp);
            document.getElementById('level').textContent = player.level;
            document.getElementById('xp').textContent = player.xp;
            document.getElementById('hunger').textContent = Math.floor(player.hunger);
            document.getElementById('xp-fill').style.width = (player.xp % 100) + '%';
        }

        function draw() {
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            ctx.save();
            ctx.translate(-camera.x, -camera.y);

            // Suelo
            ctx.fillStyle = '#2d5a27';
            ctx.fillRect(0,0, WORLD_SIZE, WORLD_SIZE);

            // Presas
            prey.forEach(p => {
                ctx.font = '30px Arial';
                ctx.fillText(PREY_TYPES[p.type].emoji, p.x, p.y);
            });

            // Lobo (Jugador)
            ctx.font = '40px Arial';
            ctx.fillText('üê∫', player.x - 20, player.y + 15);

            ctx.restore();
        }

        document.getElementById('nextMapBtn').onclick = siguienteMapa;
        document.getElementById('arenaBtn').onclick = () => tg.showAlert("Arena en desarrollo");
        document.getElementById('huntBtn').onclick = () => tg.showAlert("Modo Caza Activo");

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        spawnPrey();
        gameLoop();
    </script>
</body>
</html>
